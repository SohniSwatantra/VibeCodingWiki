---
import AppLayout from '../../../layouts/AppLayout.astro';
import { fetchDirectory, fetchPageBySlug } from '../../../lib/wiki/convexHelpers';
import { EditProposalForm } from '../../../components/wiki/EditProposalForm.tsx';

const { slug } = Astro.params;
const pageResult = await fetchPageBySlug(slug ?? '');
const article = pageResult.article;

if (!article) {
  return new Response('Article not found', { status: 404 });
}

export async function getStaticPaths() {
  const { articles } = await fetchDirectory();
  return articles.map((entry) => ({
    params: { slug: entry.slug },
  }));
}

const isAuthenticated = Boolean(Astro.locals.user);
---
<AppLayout title={`Edit proposal Â· ${article.title}`} description={`Suggest improvements or corrections to ${article.title}.`}>
  <section class="rounded border border-[#a2a9b1] bg-white p-5 shadow-sm">
    <h1 class="text-[1.75rem] font-normal text-[#202122]">Propose changes to {article.title}</h1>
    <p class="mt-2 text-sm text-[#54595d]">
      Use the form below to outline revisions. Include sources where possible so moderators can verify the update quickly.
    </p>
  </section>

  <section class="mt-4">
    <EditProposalForm client:load articleSlug={article.slug} isAuthenticated={isAuthenticated} />
  </section>
</AppLayout>

