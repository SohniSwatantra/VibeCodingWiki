---
import AppLayout from '../../../layouts/AppLayout.astro';
import { fetchPageBySlug } from '../../../lib/wiki/convexHelpers';
import { RevisionHistory } from '../../../components/wiki/RevisionHistory.tsx';

const { slug } = Astro.params;
const pageResult = await fetchPageBySlug(slug ?? '');
const article = pageResult.article;

if (!article) {
  return new Response('Article not found', {
    status: 404,
  });
}

// Check if user is authenticated (SSR mode - Astro.locals is available)
const currentUser = Astro.locals.user;
const isAuthenticated = Boolean(currentUser);
---

<AppLayout title={`${article.title} â€” History`} description={`Revision history for ${article.title}`}>
  <section class="rounded border border-[#a2a9b1] bg-white p-5 shadow-sm">
    <h1 class="text-[1.75rem] font-normal text-[#202122]">Revision history</h1>
    <p class="mt-2 text-sm text-[#54595d]">
      Track every edit applied to <strong>{article.title}</strong>. Use the filters below to inspect pending proposals, approvals, and rollbacks.
    </p>
  </section>

  <div class="mt-4">
    <RevisionHistory client:load articleSlug={article.slug} isAuthenticated={isAuthenticated} />
  </div>
</AppLayout>

