---
export const prerender = false;

import AppLayout from '../../layouts/AppLayout.astro';
import { fetchDirectory, fetchPageBySlug, getConvexUserByWorkOSId } from '../../lib/wiki/convexHelpers';
import { RevisionHistory } from '../../components/wiki/RevisionHistory.tsx';
import { EditingCallout } from '../../components/wiki/EditingCallout.tsx';
import { EditProposalForm } from '../../components/wiki/EditProposalForm.tsx';
import { ModerationPanel } from '../../components/wiki/ModerationPanel.tsx';
import { runConvexQuery } from '../../lib/convex.server';

export async function getStaticPaths() {
  const { articles } = await fetchDirectory();
  return articles.map((article) => ({
    params: { slug: article.slug },
  }));
}

const { slug } = Astro.params;
const isAuthenticated = Boolean(Astro.locals.user);

// Check if user has moderator or super_admin role
let canModerate = false;
if (Astro.locals.user) {
  const convexUser = await getConvexUserByWorkOSId(Astro.locals.user.id);
  if (convexUser) {
    const userRoles = await runConvexQuery<any[]>('roles:getUserRoles', { userId: convexUser._id });
    const roleNames = userRoles?.map((r: any) => r.role) ?? [];
    canModerate = roleNames.includes('moderator') || roleNames.includes('super_admin');
  }
}

const pageResult = await fetchPageBySlug(slug ?? '');
const articleData = pageResult.article;

if (!articleData) {
  return new Response('Article not found', { status: 404 });
}

const articleTimeline = articleData.timeline ?? [];
const relatedSlugs = articleData.relatedTopics ?? [];
const relatedArticles = relatedSlugs.length
  ? (await fetchDirectory()).articles.filter((candidate) => relatedSlugs.includes(candidate.slug))
  : [];

const sections = articleData.sections ?? [];

const formatSectionId = (heading: string) =>
  heading
    .toLowerCase()
    .trim()
    .replace(/[^a-z0-9\s-]/g, '')
    .replace(/\s+/g, '-')
    .replace(/-+/g, '-')
    .replace(/^-+|-+$/g, '');
---

<AppLayout title={articleData.title} description={articleData.summary}>
  <article class="grid gap-6 md:grid-cols-[3fr_1fr]">
    <div class="space-y-6">
      <header class="border-b border-[#a2a9b1] pb-3">
        <h1 class="text-[2rem] font-normal text-[#202122]">{articleData.title}</h1>
        <p class="text-sm text-[#54595d]">Categories: {articleData.categories.join(', ')}</p>
        <p class="text-xs text-[#72777d]">
          Created {new Date(articleData.createdAt).toLocaleDateString()} Â· Last updated{' '}
          {new Date(articleData.updatedAt).toLocaleDateString()}
        </p>
      </header>

      {sections.map((section) => {
        const heading = section.heading ?? 'Section';
        const id = formatSectionId(heading);
        const paragraphs = section.content.split(/\n\n+/).filter(Boolean);

        return (
          <section id={id} class="space-y-3">
            <h2 class="border-b border-[#a2a9b1] pb-1 text-xl font-normal text-[#202122]">{heading}</h2>
            {paragraphs.length > 0 ? (
              paragraphs.map((para) => <p class="text-sm leading-6 text-[#202122]">{para}</p>)
            ) : (
              <p class="text-sm leading-6 text-[#202122]">(Content coming soon)</p>
            )}
          </section>
        );
      })}

      {articleTimeline.length > 0 && (
        <section class="rounded border border-[#c8ccd1] bg-[#f8f9fa] p-4">
          <h2 class="mb-2 text-lg font-semibold text-[#202122]">Timeline</h2>
          <ul class="space-y-2 text-sm text-[#202122]">
            {articleTimeline.map((entry) => (
              <li class="flex gap-3">
                <span class="min-w-[3rem] font-semibold">{entry.year}</span>
                <div>
                  <p class="font-semibold">{entry.title}</p>
                  <p class="text-[#54595d]">{entry.description}</p>
                </div>
              </li>
            ))}
          </ul>
        </section>
      )}

      <EditingCallout articleTitle={articleData.title} />
      <EditProposalForm client:load articleSlug={articleData.slug} isAuthenticated={isAuthenticated} />
      <ModerationPanel client:load articleSlug={articleData.slug} canModerate={canModerate} />
      <RevisionHistory articleSlug={articleData.slug} />
    </div>

    <aside class="flex flex-col gap-4">
      <section class="rounded border border-[#c8ccd1] bg-white p-4 shadow-sm">
        <h3 class="text-base font-semibold text-[#202122]">Article tools</h3>
        <ul class="mt-2 space-y-2 text-sm text-[#0645ad]">
          <li><a href={`/wiki/${articleData.slug}/edit`}>Propose edits</a></li>
          <li><a href={`/wiki/${articleData.slug}/history`}>View history</a></li>
          <li><a href={`/wiki/${articleData.slug}/talk`}>Discuss on Talk page</a></li>
        </ul>
      </section>

      <section class="rounded border border-[#c8ccd1] bg-[#f8f9fa] p-4">
        <h3 class="text-base font-semibold text-[#202122]">Tags</h3>
        <ul class="mt-2 flex flex-wrap gap-2 text-xs">
          {articleData.tags.map((tag) => (
            <li class="rounded border border-[#a2a9b1] bg-white px-2 py-1 text-[#202122]">{tag}</li>
          ))}
        </ul>
      </section>

      {relatedArticles.length > 0 && (
        <section class="rounded border border-[#c8ccd1] bg-white p-4 shadow-sm">
          <h3 class="text-base font-semibold text-[#202122]">Related articles</h3>
          <ul class="mt-2 space-y-2 text-sm">
            {relatedArticles.map((item) => (
              <li>
                <a class="text-[#0645ad]" href={`/wiki/${item.slug}`}>{item.title}</a>
              </li>
            ))}
          </ul>
        </section>
      )}
    </aside>
  </article>
</AppLayout>
