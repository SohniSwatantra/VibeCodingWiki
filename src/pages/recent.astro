---
import AppLayout from '../layouts/AppLayout.astro';
import { RecentChanges } from '../components/app/RecentChanges.tsx';
import { getConvexUserByWorkOSId } from '../lib/wiki/convexHelpers';
import { runConvexQuery } from '../lib/convex.server';

// Check if user is super admin
let isSuperAdmin = false;
if (Astro.locals.user) {
  const convexUser = await getConvexUserByWorkOSId(Astro.locals.user.id);
  if (convexUser) {
    const userRoles = await runConvexQuery<any[]>('roles:getUserRoles', { userId: convexUser._id });
    const roleNames = userRoles?.map((r: any) => r.role) ?? [];
    isSuperAdmin = roleNames.includes('super_admin');
  }
}
---

<AppLayout
  title="Recent Changes"
  description="Recent approved changes by moderators on VibeCodingWiki"
>
  <div class="mx-auto max-w-6xl">
    <article class="rounded border border-[#a2a9b1] bg-white p-6 shadow-sm">
      <h1 class="mb-4 text-2xl font-semibold text-[#202122]">Recent Changes</h1>
      <p class="mb-6 text-sm text-[#54595d]">
        Track the latest approved edits and updates across VibeCodingWiki. All changes shown here have been reviewed and approved by moderators.
      </p>

      <RecentChanges client:load isSuperAdmin={isSuperAdmin} />
    </article>
  </div>
</AppLayout>
