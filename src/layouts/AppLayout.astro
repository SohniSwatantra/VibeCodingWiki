---
import '../styles/global.css';
import { SponsorshipBanner } from '../components/app/SponsorshipBanner.tsx';
import { getConvexUserByWorkOSId } from '../lib/wiki/convexHelpers';
import { runConvexQuery } from '../lib/convex.server';

const { title = 'VibeCoding Wiki', description = 'A collaborative knowledge base for Vibe Coders.' } = Astro.props;
const currentUser = Astro.locals.user;

let isSuperAdmin = false;
if (currentUser) {
  const convexUser = await getConvexUserByWorkOSId(currentUser.id);
  if (convexUser) {
    const userRoles = await runConvexQuery<any[]>('roles:getUserRoles', { userId: convexUser._id });
    const roleNames = userRoles?.map((r: any) => r.role) ?? [];
    isSuperAdmin = roleNames.includes('super_admin');
  }
}
---

<html lang="en" class="scroll-smooth">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
    <meta name="description" content={description} />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />

    <!-- Umami Analytics -->
    <script defer src="https://cloud.umami.is/script.js" data-website-id="7a6e24c1-9859-416d-8a2c-c57c109ae569"></script>
  </head>
  <body class="min-h-screen antialiased">
    <div class="mx-auto w-full max-w-6xl px-4 py-6">
      <div class="overflow-hidden rounded border border-[#a2a9b1] bg-white shadow-sm">
        <header class="border-b border-[#a2a9b1] bg-[#f8f9fa] px-6 py-5">
          <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
            <div class="space-y-1">
              <p class="text-xs uppercase tracking-[0.4em] text-[#72777d]">Vibecodingwiki</p>
              <h1 class="text-[2rem] font-normal leading-tight text-[#202122]">{title}</h1>
              <p class="max-w-2xl text-sm text-[#54595d]">{description}</p>
            </div>
            <form action="/search" method="get" class="flex w-full max-w-sm items-center gap-2 rounded border border-[#a2a9b1] bg-white px-3 py-1 text-sm text-[#202122]" role="search">
              <label class="sr-only" for="site-search">Search Vibecodingwiki</label>
              <input
                id="site-search"
                name="search"
                type="search"
                placeholder="Search Vibecodingwiki"
                class="w-full border-none bg-transparent py-1 text-sm text-[#202122] focus:outline-none focus:ring-0"
                required
              />
              <button
                type="submit"
                class="rounded border border-[#a2a9b1] bg-[#f8f9fa] px-2 py-1 text-xs font-semibold text-[#202122] shadow-sm hover:bg-white"
              >
                Go
              </button>
            </form>
          </div>
          <nav class="mt-4 flex flex-wrap gap-4 text-sm text-[#202122]">
            <a class="font-semibold text-[#202122] hover:text-[#0b0080]" href="/">Main page</a>
            <a class="hover:text-[#0b0080]" href="/wiki">All pages</a>
            {isSuperAdmin && (
               <a class="font-bold text-[#d33f3f] hover:text-[#b32424]" href="/admin/editor">
                 Super Admin Editor
               </a>
            )}
            <a class="hover:text-[#0b0080]" href="/submit-app">Submit an APP</a>
            <a class="hover:text-[#0b0080]" href="/newsletter">VibeCoding Newsletter</a>
            <a class="hover:text-[#0b0080]" href="/users">Contributors</a>
            <a class="hover:text-[#0b0080]" href="/coming-soon">VibeCodingWiki App</a>
            <a class="hover:text-[#0b0080]" href="/sponsors">Sponsors</a>
            <a class="hover:text-[#0b0080]" href="/about">About Creator</a>
          </nav>
          <div class="mt-3 flex flex-wrap items-center justify-end gap-2 text-xs text-[#54595d]">
            {currentUser ? (
              <>
                <span>Signed in as {currentUser.email ?? currentUser.firstName ?? 'vibecoder'}</span>
                <a class="rounded border border-[#a2a9b1] bg-white px-3 py-1 text-[#0645ad] hover:text-[#0b0080]" href="/api/auth/workos/logout">
                  Log out
                </a>
              </>
            ) : (
              <a class="rounded border border-[#a2a9b1] bg-white px-3 py-1 text-[#0645ad] hover:text-[#0b0080]" href="/login">
                Sign in
              </a>
            )}
          </div>
        </header>

        <main class="px-6 py-6">
          <slot />
        </main>

        <footer class="border-t border-[#a2a9b1] bg-[#f8f9fa] px-6 py-4 text-xs text-[#54595d] md:flex md:items-center md:justify-between">
          <p>
            Retrieved from VibeCodingWiki · Styled after MediaWiki Vector skin · Powered by Astro & TanStack.
          </p>
          <p>© {new Date().getFullYear()} VibeCodingWiki</p>
        </footer>
      </div>
    </div>
    <SponsorshipBanner client:load />
  </body>
</html>
